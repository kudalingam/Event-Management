<?php
session_start();
$conn = mysqli_connect('localhost', 'root', '', 'admin');
$email = "";
$name = "";
$errors = array();

//if user signup button
if(isset($_POST['signup'])){
    $name = mysqli_real_escape_string($conn, $_POST['name']);
    $email = mysqli_real_escape_string($conn, $_POST['email']);
    $password = mysqli_real_escape_string($conn, $_POST['password']);
    $cpassword = mysqli_real_escape_string($conn, $_POST['cpassword']);
    if($password !== $cpassword){
        $errors['password'] = "Confirm password not matched!";
    }
    $email_check = "SELECT * FROM admin WHERE Email = '$email'";
    $res = mysqli_query($conn, $email_check);
    if(mysqli_num_rows($res) > 0){
        $errors['email'] = "Email that you have entered is already exist!";
    }
    if(count($errors) === 0){
        $encpass = md5($password);
        $code = rand(999999, 111111);
        $status = "notverified";
        $file = addslashes(file_get_contents($_FILES["image"]["tmp_name"])); 
        $insert_data = "INSERT INTO admin (Name,Email,Password,Image, code, status)
                        values('$name', '$email', '$encpass','$file', '$code', '$status')";
        $data_check = mysqli_query($conn, $insert_data);
        if($data_check){
            $subject = "Email Verification Code";
            $message =" Dear $name, \n\n         Your verification OTP is ' $code '. This can be used only once and is valid for 300 secs.  Please enter the OTP to verify the email address. Do not share OTP for Security reason. \n\n\n\n\n\nRegards,\nEvent Management Team,\nEvent Management. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n Note: Please do not reply to this mail, This email is automatically generated by the event management team.";
            $sender = "From: 'Event Management' kudalingam18@gmail.com";
            if(mail($email, $subject, $message, $sender)){
                $info = "We've sent a verification code to your email - $email";
                $_SESSION['info'] = $info;
                $_SESSION['Email'] = $email;
                $_SESSION['password'] = $password;
                header('location: user-otp.php');
                exit();
            }else{
                $errors['otp-error'] = "Failed while sending code!";
            }
        }else{
            $errors['db-error'] = "Failed while inserting data into database!";
        }
    }
 
}
    //if user click verification code submit button
    if(isset($_POST['check'])){
        $_SESSION['info'] = "";
        $otp_code = mysqli_real_escape_string($conn, $_POST['otp']);
        $check_code = "SELECT * FROM admin WHERE code = $otp_code";
        $code_res = mysqli_query($conn, $check_code);
        if(mysqli_num_rows($code_res) > 0){
            $fetch_data = mysqli_fetch_assoc($code_res);
            $fetch_code = $fetch_data['code'];
            $email = $fetch_data['Email'];
            $code = 0;
            $status = 'verified';
            $update_otp = "UPDATE admin SET code = $code, status = '$status' WHERE code = $fetch_code";
            $update_res = mysqli_query($conn, $update_otp);
            if($update_res){
                header("Location:signlog.php ");
                exit();
            }else{
                $errors['otp-error'] = "Failed while updating code!";
            }
        }else{
            $errors['otp-error'] = "You've entered incorrect code!";
        }
    }

    if(isset($_POST['signin'])){
        $email=$_POST["email"];
        $pass=$_POST["password"];
        $encpass = md5($_POST['password']);
        $query=mysqli_query($conn,"select * from admin where Email='$email' and Password='$encpass'");
        $rowcount=mysqli_num_rows($query);
    if ($rowcount == 1){
        $_SESSION['Email']=$email;
        echo "<font color=blue>Welcome $email</font>";
        header("Location:indexv.php");
        exit();
    }else{
                $errors['email'] = " &#9888; Incorrect email or password!";
                echo "Invalid";
            }
}

    //if user click continue button in forgot password form
    if(isset($_POST['check-email'])){
        $email = mysqli_real_escape_string($conn, $_POST['email']);
        $check_email = "SELECT * FROM admin WHERE Email='$email'";
        $run_sql = mysqli_query($conn, $check_email);
        if(mysqli_num_rows($run_sql) > 0){
            $code = rand(999999, 111111);
            $insert_code = "UPDATE admin SET code = $code WHERE Email = '$email'";
            $run_query =  mysqli_query($conn, $insert_code);
            if($run_query){
                $subject = "Password Reset Code";
                $message =" Dear Customer, \n\n         Your verification OTP is ' $code '. This can be used only once and is valid for 300 secs.  Please enter the OTP to change the Password. Do not share OTP for Security reason. \n\n\n\n\n\nRegards,\nEvent Management Team,\nEvent Management. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n Note: Please do not reply to this mail, This email is automatically generated by the event management team.";
                $sender = "From: 'Event Management' kudalingam18@gmail.com";
                if(mail($email, $subject, $message, $sender)){
                    $info = "We've sent a passwrod reset otp to your email - $email";
                    $_SESSION['info'] = $info;
                    $_SESSION['Email'] = $email;
                    header('location: reset-code.php');
                    exit();
                }else{
                    $errors['otp-error'] = "Failed while sending code!";
                }
            }else{
                $errors['db-error'] = "Something went wrong!";
            }
        }else{
            $errors['email'] = "This email address does not exist!";
        }
    }

    //if user click check reset otp button
    if(isset($_POST['check-reset-otp'])){
        $_SESSION['info'] = "";
        $otp_code = mysqli_real_escape_string($conn, $_POST['otp']);
        $check_code = "SELECT * FROM admin WHERE code = $otp_code";
        $code_res = mysqli_query($conn, $check_code);
        if(mysqli_num_rows($code_res) > 0){
            $fetch_data = mysqli_fetch_assoc($code_res);
            $email = $fetch_data['Email'];
            $_SESSION['Email'] = $email;
            $info = "Please create a new password that you don't use on any other site.";
            $_SESSION['info'] = $info;
            header('location: new-password.php');
            exit();
        }else{
            $errors['otp-error'] = "You've entered incorrect code!";
        }
    }

    //if user click change password button
    if(isset($_POST['change-password'])){
        $_SESSION['info'] = "";
        $password = mysqli_real_escape_string($conn, $_POST['password']);
        $cpassword = mysqli_real_escape_string($conn, $_POST['cpassword']);
        if($password !== $cpassword){
            $errors['password'] = "Confirm password not matched!";
        }else{
            $code = 0;
            $email = $_SESSION['Email']; //getting this email using session
            $encpass = md5($_POST['password']);
            $update_pass = "UPDATE admin SET code = $code, Password = '$encpass' WHERE Email = '$email'";
            $run_query = mysqli_query($conn, $update_pass);
            if($run_query){
                $info = "Your password changed. Now you can login with your new password.";
                $_SESSION['info'] = $info;
                header('Location: password-changed.php');
            }else{
                $errors['db-error'] = "Failed to change your password!";
            }
        }
    }
    
   //if login now button click
    if(isset($_POST['login-now'])){
        header("Location:signlog.php ");
    }
/*$conn = mysqli_connect('localhost', 'root', '', 'login');
if(isset($_POST['signup'])){
    $name=$_POST['name'];
    $email=$_POST['email'];
    $password=$_POST['password'];
    $cpassword=$_POST['cpassword'];
    //$image=$_POST['image'];
        if(mysqli_connect_error()){
            die('Connect Error ('.mysqli_connect_error().')'.mysqli_connect_error());
        }if($password !== $cpassword){
            $errors['password'] = "Confirm password not matched!";
            echo "<br><br><h3>Confirm password not matched!";
            echo '<br/>Try again<a href="signlog.php"> Sign Up</a>';
        }
        else{
            $rs=mysqli_query($conn,"select * from admin where Email='$email'");
            if (mysqli_num_rows($rs)>0)
            {
                echo "<br><br><h3>Login Id Already Exists";
                echo '<br/>Click<a href="signlog.php"> Login</a>';
	            exit;
            }
                else{
                   // $target = "images/" .basename($_FILES['image']['name']);
                   // $image=$_FILES['image']['name'];
                    //$fileName = basename($_FILES["photo"]["name"]); 
           //$fileType = pathinfo($fileName, PATHINFO_EXTENSION); 
           //$allowTypes = array('jpg','png','jpeg','gif'); 
           //$photo = $_FILES['photo']['tmp_name']; 
           // $photo = addslashes(file_get_contents($photo)); 
           $file = addslashes(file_get_contents($_FILES["image"]["tmp_name"])); 
                    $encpass = md5($_POST['cpassword']);
                    $sql="INSERT INTO admin (Name,Email,Password,Image) values('$name','$email','$encpass','$file')";
                    if($conn->query($sql)=== TRUE){
                        ob_clean();
                        echo "New record is inserted successfully";
                        header("Location:signlog.php ");
                        exit();
                    }
                    else{
                        echo "Error: ".$sql ."<br>".$conn->error;
                    }
                    $conn->close();
                }
        }
    }
if(isset($_POST['signin'])){
        $email=$_POST["email"];
        $password=$_POST["password"];
        $encpass = md5($_POST['password']);
        $query=mysqli_query($conn,"select * from admin where Email='$email' and Password='$encpass'");
        $rowcount=mysqli_num_rows($query);
    if ($rowcount == 1){
        $_SESSION['Email']=$email;
        echo "<font color=blue>Welcome $email</font>";
        header("Location:indexv.php");
        exit();
    }else{
        echo "<font color=red size=6pts>Invalid email or password";
        echo "<br><br>Click <a href='signlog.php'> Login</a>";
    }
}
*/
 //if user click login button
   /* if(isset($_POST['login'])){
        $email = mysqli_real_escape_string($conn, $_POST['email']);
        $password = md5($_POST['password']);
        $check_email = "SELECT * FROM usertable WHERE email = '$email'";
        $res = mysqli_query($conn, $check_email);
        if(mysqli_num_rows($res) > 0){
            $fetch = mysqli_fetch_assoc($res);
            $fetch_pass = $fetch['password'];
            if(password_verify($password, $fetch_pass)){
                $_SESSION['email'] = $email;
                $status = $fetch['status'];
                if($status == 'verified'){
                  $_SESSION['email'] = $email;
                  $_SESSION['password'] = $password;
                    header('location: home.php');
                }else{
                    $info = "It's look like you haven't still verify your email - $email";
                    $_SESSION['info'] = $info;
                    header('location: user-otp.php');
                }
            }else{
                $errors['email'] = "Incorrect email or password!";
            }
        }else{
            $errors['email'] = "It's look like you're not yet a member! Click on the bottom link to signup.";
        }
}*/
?>
